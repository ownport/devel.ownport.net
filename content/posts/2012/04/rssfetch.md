Title: Изменения в rssfetch
Author: d.rey
Date: 2012-04-18 09:07:00
Slug: rssfetch
Tags: kvlite2,fetch,python,feedparser,rss

Опубликовал новую версию [rssfetch](http://code.google.com/p/sources-ownport/source/browse/rssfetch) - загрузчик RSS лент с использованием Universal Feed Parser и KVLite2, используемый для периодической проверки наличия новых постов для выбранных RSS лент и хранение их в базе данных для последующей обработки. 

**Изменения:**

rssfetch перешел на хранение RSS данных в [PySimpleFeed формате](http://devel.ownport.net/2012/03/pysimplefeed-rss.html). Это позволило значительно упростить и унифицировать структуру данных. Выигрыш от использования PySimpleFeed - экономия порядка 40% дисковой емкости. Для миграции старых данных с использованием нового формата необходимо воспользоваться скриптом migr.py.

_Важно_: Перед использование скрипта migr.py необходимо выполнять резераное хранение данных.

    :::text
    # python migr.py --migrate_to_simplefeed

используется единый формат представления даты и времени для полей  entry.published, entry.updated, entry.edited. Для обновления существующих данных
 
    :::text
    # python migr.py --unify_datetime

при добавлении новых постов в базу данных  добавляются поля entry.source.sha1 и entry.source.href, содержащие SHA1 хеш и ссылку на RSS ленту. Для добавления этих полей для существующих данных:

    :::text
    # python migr.py --update_source
    
для каждой ленты feed добавлены новые поля ‘last_updated’ и ‘posts_per_requrest’. Значение этих полей использутся для вычисления времени, когда необходимо выполнять запрос на наличие новых постов для каждой ленты.

исправлена проблема с хранением и передачей ETag

добавлена новая функциональность - вывод дополнительной информации о RSS лентах: порядковый номер ленты, SHA1 хеш от сссылки на ленту, диаграмма появления новых постов от времени, дата и время последней модификации по информации от сервера, дата и время последнего опроса rssfetch, значение ETag, ссылка на ленту, число постов в ответе сервера

PySimpleFeed удаляет поля со значением None

добавлена оптимизация запросов к серверам на наличие новых данных. При первом запуске rssfetch.py -u, за сутки, опрашиваются все ленты. Установлено органичение на опрос одной и той же ленты не чаще чем раз за интервал, установленый в параметре settings.TIME_INTERVAL. На основе истории предыдущих запросов прнимается решение о выполнении запроса к серверу, если за интервал времени от последнего опроса до текущего времени было опубликовано постов больше половины от общего количества постов, возвращаемых за один ответ от сервера. Для обновления матрицы распределения даты и времени постов необходимо выполнить команду

    :::python
    # python rssfetch.py --update_factor

в получаемых данных для некоторых лент поля entry.edited, entry.published, entry.updated не заполнены, это приводит к некорректному формированию матрицы распределения постов. Для того, чтобы минимизировать отклоннения, для постов которые не содержат данных полей rssfetch формирует поле entry.updated с указанием даты и времени опроса ленты

добавлена возможность выполнения оптимизации и изменения структуры полей для существующих постов. Зачастую при добавлении новых лент появляются и новые поля, которые ранее не были описаны в PySimpleFeed. Большинство из этих новых полей переносятся в “черный” список, т.к. не содежат полезной информации. Запуск 

    :::text
    # python rssfetch.py --optimize_fields

позволяет привести посты всех лент к единому формату в случае внесения изменений в  PySimpleFeed формате или если поля внесены в  “черный” список

добавлена возможность выводить информацию по всем полям хранимых в базе данных, их частоте использования, а также если поле не внесено в список FIXED_FIELD_LIST, то промаркировать его со статусом ‘new’. Пример вывода для тестовой базы:

    :::python
    {u'entry.authors': {'count': 2070},
    u'entry.comments': {'count': 1307},
    u'entry.content.html': {'count': 1818},
    u'entry.content.rights': {'count': 118},
    u'entry.content.subtitle': {'count': 251},
    u'entry.content.text': {'count': 168},
    u'entry.content.xml': {'count': 2},
    u'entry.edited': {'count': 125},
    u'entry.language': {'count': 134},
    u'entry.links': {'count': 3196},
    u'entry.media.urls': {'count': 847},
    u'entry.published': {'count': 4117},
    u'entry.publisher': {'count': 118},
    u'entry.source.href': {'count': 3196},
    u'entry.source.sha1': {'count': 4305},
    u'entry.summary': {'count': 4286},
    u'entry.tags.scheme': {'count': 1286},
    u'entry.tags.term': {'count': 3340},
    u'entry.text': {'count': 47},
    u'entry.title': {'count': 4279},
    u'entry.updated': {'count': 917}}
    Total feed entries: 4305

